From ddefd7fd6716d5f092e5005aeb24c92d31323d5f Mon Sep 17 00:00:00 2001
From: Martin Willi <martin@strongswan.org>
Date: Tue, 7 Jul 2015 21:20:46 +0200
Subject: [PATCH 00/10] crypto: x86_64 - Add SSE/AVX2 ChaCha20/Poly1305 ciphers

This patch series adds both ChaCha20 and Poly1305 specific ciphers for
x86_64 using SSE2/SSSE3 and AVX2 instructions. The idea is to have a drop-in
replacement for AESNI/CLMUL-accelerated AES-GCM providing at least somewhat
comparable performance, refer to RFC7539 for details. It is based
on cryptodev.

The first patch adds some speed tests to tcrypt. The second patch exports
some functionality from chacha20-generic to use it as fallback. Patch 3
adds a single block SSSE3 driver for ChaCha20, while patch 4 and 5 extend it
by an optimized four block SSSE3 and an eight block AVX2 variant. Patch 6
adds an additional test vector for ChaCha20 to actually test the AVX2 eight
block variant processing 512-bytes at once.

Patch 7 exports some poly1305-generic functionality to use it as fallback.
Patch 8 introduces a single block SSE2 driver for Poly1305, while patch 9
and 10 add an optimized two block SSE2 and a four block AVX2 variant.

Overall speedup for the ChaCha20/Poly1305 AEAD for typical IPsec payloads
is ~50-150% with SSE2/SSSE3 and ~100-200% with AVX2, or even more for larger
payloads:

poly1305-generic:
testing speed of rfc7539esp(chacha20,poly1305) (rfc7539esp(chacha20-generic,poly1305-generic)) encryption
test 0 (288 bit key, 16 byte blocks): 9844661 operations in 10 seconds (157514576 bytes)
test 1 (288 bit key, 64 byte blocks): 9447010 operations in 10 seconds (604608640 bytes)
test 2 (288 bit key, 256 byte blocks): 5610895 operations in 10 seconds (1436389120 bytes)
test 3 (288 bit key, 512 byte blocks): 3665251 operations in 10 seconds (1876608512 bytes)
test 4 (288 bit key, 1024 byte blocks): 2163841 operations in 10 seconds (2215773184 bytes)
test 5 (288 bit key, 2048 byte blocks): 1188129 operations in 10 seconds (2433288192 bytes)
test 6 (288 bit key, 4096 byte blocks): 625748 operations in 10 seconds (2563063808 bytes)
test 7 (288 bit key, 8192 byte blocks): 319556 operations in 10 seconds (2617802752 bytes)

SSE2/SSSE3:
testing speed of rfc7539esp(chacha20,poly1305) (rfc7539esp(chacha20-simd,poly1305-simd)) encryption
test 0 (288 bit key, 16 byte blocks): 9481808 operations in 10 seconds (151708928 bytes)
test 1 (288 bit key, 64 byte blocks): 9423462 operations in 10 seconds (603101568 bytes)
test 2 (288 bit key, 256 byte blocks): 7612168 operations in 10 seconds (1948715008 bytes)
test 3 (288 bit key, 512 byte blocks): 6119230 operations in 10 seconds (3133045760 bytes)
test 4 (288 bit key, 1024 byte blocks): 4474086 operations in 10 seconds (4581464064 bytes)
test 5 (288 bit key, 2048 byte blocks): 2908465 operations in 10 seconds (5956536320 bytes)
test 6 (288 bit key, 4096 byte blocks): 1709321 operations in 10 seconds (7001378816 bytes)
test 7 (288 bit key, 8192 byte blocks): 920243 operations in 10 seconds (7538630656 bytes)

AVX2:
testing speed of rfc7539esp(chacha20,poly1305) (rfc7539esp(chacha20-simd,poly1305-simd)) encryption
test 0 (288 bit key, 16 byte blocks): 9498006 operations in 10 seconds (151968096 bytes)
test 1 (288 bit key, 64 byte blocks): 9423516 operations in 10 seconds (603105024 bytes)
test 2 (288 bit key, 256 byte blocks): 7597253 operations in 10 seconds (1944896768 bytes)
test 3 (288 bit key, 512 byte blocks): 6979753 operations in 10 seconds (3573633536 bytes)
test 4 (288 bit key, 1024 byte blocks): 5629328 operations in 10 seconds (5764431872 bytes)
test 5 (288 bit key, 2048 byte blocks): 4071284 operations in 10 seconds (8337989632 bytes)
test 6 (288 bit key, 4096 byte blocks): 2627325 operations in 10 seconds (10761523200 bytes)
test 7 (288 bit key, 8192 byte blocks): 1492531 operations in 10 seconds (12226813952 bytes)

All benchmark results from a Core i5-4670T.

The ChaCha20/Poly1305 AEAD on Haswell with AVX2 has about half the raw
AESNI/CLMUL-accelerated AES-GCM (rfc4106-gcm-aesni) performance for typical
IPsec MTUs. On Ivy Bridge using SSE2/SSSE3 the numbers compared to AES-GCM
are very similar due to the less efficient CLMUL instructions.

Martin Willi (10):
  crypto: tcrypt - Add ChaCha20/Poly1305 speed tests
  crypto: chacha20 - Export common ChaCha20 helpers
  crypto: chacha20 - Add a SSSE3 SIMD variant for x86_64
  crypto: chacha20 - Add a four block SSSE3 variant for x86_64
  crypto: chacha20 - Add an eight block AVX2 variant for x86_64
  crypto: testmgr - Add a longer ChaCha20 test vector
  crypto: poly1305 - Export common Poly1305 helpers
  crypto: poly1305 - Add a SSE2 SIMD variant for x86_64
  crypto: poly1305 - Add a two block SSE2 variant for x86_64
  crypto: poly1305 - Add a four block AVX2 variant for x86_64

 arch/x86/crypto/Makefile                |   6 +
 arch/x86/crypto/chacha20-avx2-x86_64.S  | 443 ++++++++++++++++++++++
 arch/x86/crypto/chacha20-ssse3-x86_64.S | 625 ++++++++++++++++++++++++++++++++
 arch/x86/crypto/chacha20_glue.c         | 150 ++++++++
 arch/x86/crypto/poly1305-avx2-x86_64.S  | 386 ++++++++++++++++++++
 arch/x86/crypto/poly1305-sse2-x86_64.S  | 582 +++++++++++++++++++++++++++++
 arch/x86/crypto/poly1305_glue.c         | 207 +++++++++++
 crypto/Kconfig                          |  27 ++
 crypto/chacha20_generic.c               |  28 +-
 crypto/chacha20poly1305.c               |   7 +-
 crypto/poly1305_generic.c               |  73 ++--
 crypto/tcrypt.c                         |  15 +
 crypto/tcrypt.h                         |  20 +
 crypto/testmgr.h                        | 334 ++++++++++++++++-
 include/crypto/chacha20.h               |  25 ++
 include/crypto/poly1305.h               |  41 +++
 16 files changed, 2909 insertions(+), 60 deletions(-)
 create mode 100644 arch/x86/crypto/chacha20-avx2-x86_64.S
 create mode 100644 arch/x86/crypto/chacha20-ssse3-x86_64.S
 create mode 100644 arch/x86/crypto/chacha20_glue.c
 create mode 100644 arch/x86/crypto/poly1305-avx2-x86_64.S
 create mode 100644 arch/x86/crypto/poly1305-sse2-x86_64.S
 create mode 100644 arch/x86/crypto/poly1305_glue.c
 create mode 100644 include/crypto/chacha20.h
 create mode 100644 include/crypto/poly1305.h

--
1.9.1
